<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>阿SFAG的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="WebSocket定义​		webSocket是HTML5开始提供的一种浏览器和服务器之间进行全双工通信的网络技术，在 WebSocket API 中，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。  WebSocket 是 HTML5 中提出的新的网络协议标准，其包含几个特点： 建立与TCP协议基础上的应用层 一旦建立连接（">
<meta property="og:type" content="article">
<meta property="og:title" content="阿SFAG的个人博客">
<meta property="og:url" content="http://example.com/2022/06/26/webSocket/index.html">
<meta property="og:site_name" content="阿SFAG的个人博客">
<meta property="og:description" content="WebSocket定义​		webSocket是HTML5开始提供的一种浏览器和服务器之间进行全双工通信的网络技术，在 WebSocket API 中，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。  WebSocket 是 HTML5 中提出的新的网络协议标准，其包含几个特点： 建立与TCP协议基础上的应用层 一旦建立连接（">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-06-26T14:10:59.785Z">
<meta property="article:modified_time" content="2021-12-14T09:29:18.704Z">
<meta property="article:author" content="shangguandanyu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="阿SFAG的个人博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">阿SFAG的个人博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-webSocket" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/26/webSocket/" class="article-date">
  <time class="dt-published" datetime="2022-06-26T14:10:59.785Z" itemprop="datePublished">2022-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>​		webSocket是HTML5开始提供的一种浏览器和服务器之间进行全双工通信的网络技术，在 WebSocket API 中，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。</p>
<ul>
<li>WebSocket 是 HTML5 中提出的新的网络协议标准，其包含几个特点：<ul>
<li>建立与TCP协议基础上的应用层</li>
<li>一旦建立连接（直到断开或者出错），服务端与客户端握手后则一直保持连接状态，是持久化状态；</li>
<li>服务端可通过实时通道主动下发消息；</li>
<li>数据接收的实时性和时序性</li>
<li>较少的控制开销，连接创建后，ws客户端、服务端进行数据交换时，协议控制的数据包头部较小</li>
<li>支持扩展。ws协议定义了扩展，用户可以扩展协议，或者实现自定义的子协议（比如支持自定义压缩算法等）</li>
</ul>
</li>
</ul>
<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><ul>
<li><p>在支持WebSocket的浏览器中会提供原生的WebSocket对象，其中对于消息的接收和数据帧处理在浏览器中已经封装好了</p>
</li>
<li><p>使用new关键字实例化一个webSocket:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> webSocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="title class_">String</span> url,optional <span class="title class_">String</span> | [] protocols);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>url 表示需要连接的地址，比如：ws:&#x2F;&#x2F;localhost:8080；</p>
</li>
<li><p>protocols：可选参数，可以是一个字符串或者一个数组，用来表示子协议，这样可以让一个服务器实现多种WebSocket子协议</p>
</li>
<li><p>send 接收一个 String|ArrayBuffer|Blob 数据，作为数据发送到服务端</p>
<p><strong>bolb</strong>表示一个不可变得、原始数据的类文件对象，它的数据可以按文本或二进制的格式进行读取，也可以转换成 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream"><code>ReadableStream</code></a> 来用于数据操作。 </p>
</li>
<li><p>close 接收一个（可选）的 code（关闭状态号，默认为 1000） 与一个（可选）的字符串（表示断开原因），客户端主动断开连接</p>
</li>
</ul>
</li>
<li><p>WebSocket 类提供了一些常量表示连接状态：</p>
<ul>
<li>WebSocket.CONNECTING 0 ：连接还没开启；</li>
<li>WebSocket.OPEN 1 ：连接已开启并准备好进行通信；</li>
<li>WebSocket.CLOSING 3 ：连接正在关闭的过程中；</li>
<li>WebSocket.CLOSED 4 ：连接已经关闭，或者连接无法建立；</li>
<li>WebSocket 的实例对象中提供了 readyState 属性来判断当前状态；</li>
</ul>
</li>
<li><p>实例化的对象可以监听到以下事件：</p>
<ul>
<li>open：连接打开的回调事件，这时候readyState变为OPEN</li>
<li>message：收到的回调事件，同时回调函数收到一个MessageEvent数据</li>
<li>close：连接关闭的回调事件，这时候readyState变为CLOSED</li>
<li>error：建立连接过程发生错误的回调事件</li>
</ul>
</li>
</ul>
<h3 id="事件与数据"><a href="#事件与数据" class="headerlink" title="事件与数据"></a>事件与数据</h3><ul>
<li>对webSocket实例监听有两种方式，这里以message事件为例：<ul>
<li>对 onmessage 属性直接赋值，正如以上：ws.onmessage &#x3D; function () {};</li>
<li>使用 addEventListener 监听事件，如：ws.addEventListener(‘message’, function () {})；</li>
</ul>
</li>
</ul>
<h3 id="连接稳定性"><a href="#连接稳定性" class="headerlink" title="连接稳定性"></a>连接稳定性</h3><ul>
<li>由于网络环境负责，某些情况会出现断开连接或者连接出错，需要我们在close或者error时间中监听非正常断开并重连</li>
<li>由于一些原因在error时浏览器并不会响应回调事件，因此稳妥的做法还需要在open之后来开启一个定时任务去判断当前的连接状态readyState，在出现异常时尝试重连</li>
</ul>
<h3 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h3><ul>
<li>webSocket规范定义了心跳机制，一方可以通过发送ping消息给另一方，另一方收到ping后应该尽可能块的返回pong</li>
<li>心跳机制是用于检测连接的对方在线状态，应此如果没有心跳，那么无法判断一方还在连接状态中，一些网络层比如 nginx 或者浏览器层会主动断开连接</li>
<li>在 JavaScript 中，WebSocket 并没有开放 ping&#x2F;pong 的 API ，虽然浏览器自带了心跳处理，然而不同厂商的实现也不尽相同，因此需要在我们开发时候与服务端约定好一个自实现的心跳机制；</li>
</ul>
<h3 id="网络协议"><a href="#网络协议" class="headerlink" title="网络协议"></a>网络协议</h3><p>Websocket 连接分为建连阶段与连接阶段，在建立连接阶段借助于 HTTP ，而在连接阶段则与 HTTP 无关。</p>
<ul>
<li><p>建立连接</p>
<p>重点请求首部意义如下：</p>
<ul>
<li>Connection: Upgrade：表示要升级协议</li>
<li>Upgrade: websocket：表示要升级到websocket协议。</li>
<li>Sec-WebSocket-Version: 13：表示websocket的版本。如果服务端不支持该版本，需要返回一个Sec-WebSocket-Versionheader，里面包含服务端支持的版本号。</li>
<li>Sec-WebSocket-Key ：是一个 Base64 encode 的值，由浏览器随机生成的，用于验证服务器连接的正确性；与后面服务端响应首部的Sec-WebSocket-Accept是配套的，提供基本的防护，比如恶意的连接，或者无意的连接。</li>
<li>Connection 为 Upgrade ，Upgrade 为 websocket ，表示告知 Nginx 与 Apache 等服务器该次连接并非为 HTTP 连接，实质上是一个 websocket ，因此服务器会转发到相应的 websocket 任务处理；</li>
<li>Sec-WebSocket-Versio 表示为使用的 websocket 服务版本；</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/26/webSocket/" data-id="cl4vgwma7000qu8gv12f2co1c" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/06/26/Zookeeper/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2022/06/26/SpringMVC/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/06/26/RabbitMQ%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/26/redis/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/26/Nginx/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/26/PMO%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/06/26/ody-db/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 shangguandanyu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>